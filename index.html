<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FunaTrace – Funadhoo Address Finder</title>
  <meta name="description" content="Find every address in Sh. Funadhoo with pinpoint accuracy using FunaTrace.">
  <style>
    html, body {
      height: 100%; margin: 0; font-family: sans-serif;
    }
    #map {
      width: 100%; height: 100%;
    }
    header {
      position: fixed;
      top: 0; left: 0; width: 100%;
      background: #fff; z-index: 10;
      padding: 8px 12px;
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid #ccc;
    }
    .search-bar {
      display: flex; align-items: center;
      gap: 6px;
    }
    .search-bar input {
      padding: 6px; font-size: 1em;
    }
    .search-bar button {
      padding: 4px 8px;
      font-size: 1em; cursor: pointer;
    }
    #loader {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 1em;
      border: 1px solid #ccc;
      z-index: 20;
    }
    .floating-buttons {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 99;
    }
    .floating-buttons button {
      background: #4285f4;
      color: white;
      padding: 10px 14px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<header>
  <h2>FunaTrace</h2>
  <div class="search-bar">
    <input id="search" placeholder="Search house..." list="house-list" />
    <button id="clear">✖</button>
    <datalist id="house-list"></datalist>
  </div>
</header>

<div id="map"></div>
<div id="loader">Loading map & house data…</div>

<div class="floating-buttons">
  <button id="reset">Reset</button>
  <button id="directions">Directions</button>
  <button id="open-maps">Open in Maps</button>
  <button id="share">Share</button>
</div>

<script>
  let map, currentMarker = null, houseData = [];

  const bounds = {
    north: 6.1585, south: 6.1525,
    east: 73.2895, west: 73.2810
  };

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 6.1555, lng: 73.2855 },
      zoom: 17,
      gestureHandling: "greedy",
      streetViewControl: false,
      mapTypeControl: false,
      restriction: {
        latLngBounds: {
          north: bounds.north, south: bounds.south,
          east: bounds.east, west: bounds.west
        },
        strictBounds: false
      }
    });

    fetchHouseData();
    locateUser();
  }

  function fetchHouseData() {
    const URL = "https://script.google.com/macros/s/AKfycbyaX0GcQcoVr7dIxSDepNDS3EnY5_lIC1al8qSu75edHDCiVHiQ7P2M9y3GuCFTkXEe/exec";

    fetch(URL)
      .then(r => r.json())
      .then(data => {
        houseData = data;
        const datalist = document.getElementById("house-list");
        datalist.innerHTML = "";
        data.forEach(h => {
          const opt = document.createElement("option");
          opt.value = h.name;
          datalist.appendChild(opt);
        });
        document.getElementById("loader").style.display = "none";
      })
      .catch(err => {
        console.error("Error loading house data:", err);
        alert("Failed to load house data.");
      });
  }

  function locateUser() {
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      if (
        lat >= bounds.south && lat <= bounds.north &&
        lng >= bounds.west && lng <= bounds.east
      ) {
        map.panTo({ lat, lng });
      }
    });
  }

  function setMarker(name, lat, lng) {
    if (currentMarker) currentMarker.setMap(null);
    currentMarker = new google.maps.Marker({
      position: { lat, lng },
      map,
      title: name
    });
    map.panTo({ lat, lng });

    document.getElementById("directions").onclick = () =>
      window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`);
    document.getElementById("open-maps").onclick = () =>
      window.open(`https://www.google.com/maps?q=${lat},${lng}`);
    document.getElementById("share").onclick = () => {
      const url = `https://www.google.com/maps?q=${lat},${lng}`;
      navigator.clipboard.writeText(url).then(() => alert("Link copied to clipboard!"));
    };
  }

  document.getElementById("search").addEventListener("change", e => {
    const name = e.target.value.trim();
    const match = houseData.find(h => h.name === name);
    if (match) setMarker(match.name, parseFloat(match.lat), parseFloat(match.lng));
  });

  document.getElementById("clear").onclick = () => {
    document.getElementById("search").value = "";
  };

  document.getElementById("reset").onclick = () => {
    if (currentMarker) currentMarker.setMap(null);
    currentMarker = null;
    map.setCenter({ lat: 6.1555, lng: 73.2855 });
    map.setZoom(17);
  };

  // Expose initMap globally for Google Maps
  window.initMap = initMap;
</script>

<!-- Google Maps API -->
<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOVYRIgupAurZup5y1PRh8Ismb1A3lLao&libraries=places&callback=initMap">
</script>

</body>
</html>
